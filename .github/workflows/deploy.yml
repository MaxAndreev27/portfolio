name: Deploy to DigitalOcean App Platform

on:
  # !!! ВИПРАВЛЕННЯ: Використовуємо workflow_run замість push
  # Цей workflow запускається після завершення (completed) workflows 'tests' ТА 'linter'.
  # Ми будемо перевіряти статус 'success' у кроках job.
  workflow_run:
    workflows: ["tests", "linter"] # Назви workflow з файлів tests.yml та lint.yml
    types:
      - completed

jobs:
  # Job deploy тепер є першим і не має залежностей needs, тому помилки не буде.
  deploy:
    name: DO App Deploy
    runs-on: ubuntu-latest

    # Головна умова: запускати лише якщо workflow, що тригерує, був успішним
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # Крок 1: Отримання коду
      # Примітка: workflow_run не надає автоматично доступ до коду, тому потрібен цей крок.
      # Ми чекаємо, поки всі необхідні workflows (які були успішними) завершаться.
      - name: Wait for other workflows (Optional, for clarity)
        run: echo "Waiting for Linter and Tests workflows to finish checking their status..."

      - name: Checkout Code
        uses: actions/checkout@v4

      # Крок 2: Встановлення doctl CLI та авторизація
      - name: Install doctl and Authenticate
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      # Крок 3: Ініціація деплою
      - name: Deploy to DigitalOcean
        # Вам потрібно вказати гілку, з якої береться код, щоб doctl знав, що деплоїти.
        # Оскільки тригер не push, нам потрібно вказати гілку:
        run: doctl apps create-deployment portfolio --branch ${{ github.event.workflow_run.head_branch }}
